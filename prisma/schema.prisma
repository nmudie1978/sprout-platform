// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  YOUTH
  EMPLOYER
  ADMIN
  COMMUNITY_GUARDIAN
}

// Authentication provider used for sign-up/login
enum AuthProvider {
  EMAIL        // Email + password (legacy/fallback)
  VIPPS        // Vipps Login (recommended for youth)
  BANKID       // BankID verification (required for adults)
}

// Youth age bands - expanded to include under 16
enum YouthAgeBand {
  UNDER_SIXTEEN      // Under 16 (restricted job types)
  SIXTEEN_SEVENTEEN  // 16-17 (most jobs, guardian consent required)
  EIGHTEEN_TWENTY    // 18-20 (adult, no consent needed)
}

enum AgeBracket {
  SIXTEEN_SEVENTEEN
  EIGHTEEN_TWENTY
}

// Payment methods for informational agreements (NO money through platform)
enum PaymentMethod {
  VIPPS          // Vipps mobile payment
  CASH           // Cash payment
  BANK_TRANSFER  // Bank transfer
}

// Payment agreement status (informational only - no transactions)
enum PaymentAgreementStatus {
  AGREED       // Both parties agreed on terms
  MARKED_PAID  // One party marked as paid (informational)
}

enum JobStatus {
  DRAFT
  POSTED
  ON_HOLD
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  REVIEWED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum PayType {
  FIXED
  HOURLY
}

enum JobCategory {
  BABYSITTING
  DOG_WALKING
  SNOW_CLEARING
  CLEANING
  DIY_HELP
  TECH_HELP
  ERRANDS
  OTHER
}

enum SwipeDirection {
  LEFT
  RIGHT
  UP
  DOWN
}

enum QuestionStatus {
  PENDING
  ANSWERED
  PUBLISHED
  REJECTED
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

// Community Guardian Report system
enum CommunityReportTargetType {
  JOB_POST
  USER
}

enum CommunityReportStatus {
  OPEN
  UNDER_REVIEW
  ACTION_TAKEN
  ESCALATED
  RESOLVED
  DISMISSED
}

enum AvailabilityStatus {
  AVAILABLE
  BUSY
  NOT_LOOKING
}

enum PokeStatus {
  PENDING
  READ
  ACCEPTED
  DECLINED
}

// Account status for safety controls
enum AccountStatus {
  ONBOARDING           // Just signed up, needs to complete setup
  PENDING_VERIFICATION // Youth: awaiting guardian consent, Employer: awaiting EID
  ACTIVE               // Fully verified and active
  SUSPENDED            // Temporarily suspended (can be reinstated)
  BANNED               // Permanently banned
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  password      String?       // Hashed password (nullable for OAuth/Vipps users)
  emailVerified DateTime?
  role          UserRole      @default(YOUTH)
  ageBracket    AgeBracket?
  dateOfBirth   DateTime?     // For age verification (all users)
  location      String?
  doNotDisturb  Boolean       @default(false) // Prevents new conversations
  accountStatus AccountStatus @default(ONBOARDING) // Safety status
  suspendedAt   DateTime?     // When account was suspended/banned
  suspensionReason String?    @db.Text // Why account was suspended/banned

  // ============================================
  // SAFETY: Authentication & Identity Fields
  // ============================================
  authProvider      AuthProvider  @default(EMAIL)     // How user signed up
  fullName          String?       // Full legal name from Vipps/BankID
  phoneNumber       String?       // Phone number (from Vipps or manual)
  phoneVerified     Boolean       @default(false)     // Phone verified via Vipps/SMS
  phoneVerifiedAt   DateTime?

  // Adult verification (REQUIRED for adults to contact youth)
  isVerifiedAdult   Boolean       @default(false)     // BankID verified adult
  verificationProvider String?    // 'BANKID' | 'VIPPS' (for audit)
  verifiedAt        DateTime?     // When identity was verified

  // Youth age band (more granular than AgeBracket)
  youthAgeBand      YouthAgeBand? // UNDER_SIXTEEN, SIXTEEN_SEVENTEEN, EIGHTEEN_TWENTY

  // Community Guardian moderation (soft freeze)
  isPaused      Boolean       @default(false)
  pausedAt      DateTime?
  pausedReason  String?       @db.Text
  pausedById    String?       // Who paused this user (guardian or admin)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  youthProfile    YouthProfile?
  employerProfile EmployerProfile?
  postedJobs      MicroJob[]
  applications    Application[]
  reviews         Review[]        @relation("ReviewsGiven")
  receivedReviews Review[]        @relation("ReviewsReceived")
  swipes          Swipe[]
  questions       ProQuestion[]
  answers         ProAnswer[]
  reports         Report[]
  aiIntentLogs    AiIntentLog[]
  accounts        Account[]
  sessions        Session[]
  sentPokes       Poke[]          @relation("EmployerPokes")
  receivedPokes   Poke[]          @relation("YouthReceivedPokes")
  notifications   Notification[]
  earnings        Earning[]
  badges          Badge[]
  recommendationsMade      Recommendation[] @relation("RecommendationsMade")
  recommendationsReceived  Recommendation[] @relation("RecommendationsReceived")
  recommendationsForEmployer Recommendation[] @relation("RecommendationsForEmployer")

  // Messaging (universal - any user can message any user)
  conversationsAsParticipant1 Conversation[] @relation("ConversationParticipant1")
  conversationsAsParticipant2 Conversation[] @relation("ConversationParticipant2")
  messagesSent                Message[]      @relation("MessagesSent")

  // Favorites and Notes
  favoriteWorkers       FavoriteWorker[] @relation("EmployerFavorites")
  favoritedBy           FavoriteWorker[] @relation("FavoritedBy")
  workerNotes           WorkerNote[]     @relation("EmployerNotes")
  notesAbout            WorkerNote[]     @relation("NotesAbout")

  // Job Templates
  jobTemplates          JobTemplate[]

  // Community Guardian system
  guardianAssignments   CommunityGuardian[] @relation("GuardianUser")
  communityReports      CommunityReport[]   @relation("CommunityReporter")
  assignedReports       CommunityReport[]   @relation("AssignedGuardian")

  // Safety messaging (Phase 1)
  blocksMade            UserBlock[]            @relation("BlocksMade")
  blocksReceived        UserBlock[]            @relation("BlocksReceived")
  conversationReportsMade     ConversationReport[] @relation("ReportsMade")
  conversationReportsReceived ConversationReport[] @relation("ReportsReceived")

  // Payment agreements (informational only - NO transactions)
  paymentAgreementsMarked PaymentAgreement[] @relation("PaymentMarkedBy")

  // Life Skills Track
  lifeSkillEvents          LifeSkillEvent[]
  lifeSkillRecommendations LifeSkillRecommendation[]
  lifeSkillViews           LifeSkillView[]
  preferences              UserPreferences?

  // Growth & Skills Tracking (Features 4 & 5)
  youthJobCompletions    JobCompletion[] @relation("YouthJobCompletions")
  employerJobCompletions JobCompletion[] @relation("EmployerJobCompletions")
  trustSignals           TrustSignal[]

  @@index([email])
  @@index([role])
  @@index([accountStatus])
  @@index([isPaused])
  @@index([isVerifiedAdult])
  @@index([authProvider])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model YouthProfile {
  id                 String             @id @default(cuid())
  userId             String             @unique
  displayName        String
  avatarId           String?            @default("kawaii-star") // Fun avatar identifier
  phoneNumber        String?            // Contact number for employers
  bio                String?            @db.Text
  availability       String?
  availabilityStatus AvailabilityStatus @default(AVAILABLE)
  interests          String[]           // Array of interest tags
  skillTags          String[]           // Array of skill tags
  profileVisibility  Boolean            @default(false) // OFF by default
  publicProfileSlug  String?            @unique
  completedJobsCount Int                @default(0)
  averageRating      Float?
  reliabilityScore   Int                @default(0) // 0-100
  careerAspiration   String?            // e.g., "I want to be a software developer"

  // Guardian consent (required for under-18)
  guardianEmail     String?
  guardianConsent   Boolean   @default(false)
  guardianConsentAt DateTime? // When consent was given
  guardianToken     String?   @unique // Token for guardian consent link

  // Phone verification
  phoneVerified     Boolean   @default(false)
  phoneVerifiedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([publicProfileSlug])
  @@index([availabilityStatus])
  @@index([guardianToken])
  @@index([profileVisibility])
  @@index([averageRating])
  @@index([completedJobsCount])
}

model EmployerProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  companyName    String
  companyLogo    String?  // URL to uploaded logo/profile picture
  phoneNumber    String?  // Contact number for youth workers
  bio            String?  @db.Text // About the company
  website        String?
  verified       Boolean  @default(false)

  // Age verification (must be 18+ to hire minors)
  ageVerified    Boolean   @default(false)
  dateOfBirth    DateTime? // Deprecated: use User.dateOfBirth instead

  // EID (Norwegian BankID/Vipps) verification
  eidVerified    Boolean   @default(false)
  eidVerifiedAt  DateTime?
  eidProvider    String?   // e.g., "bankid", "vipps" (for future use)

  averageRating  Float?
  totalReviews   Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eidVerified])
}

model MicroJob {
  id          String      @id @default(cuid())
  title       String
  category    JobCategory
  description String      @db.Text
  payType     PayType
  payAmount   Float
  location    String
  latitude    Float?      // For map view
  longitude   Float?      // For map view
  startDate   DateTime?   // When the job starts
  endDate     DateTime?   // When the job ends
  dateTime    DateTime?   // Legacy field - use startDate instead
  duration    Int? // in minutes
  status      JobStatus   @default(DRAFT)
  statusReason String?    @db.Text // Reason for status change (e.g., ON_HOLD, CANCELLED)
  requiredTraits String[] // e.g., "reliable", "friendly"
  images      String[]    // Array of job photo URLs (Supabase Storage)
  applicationDeadline DateTime? // Deadline for applications
  displayOrder Int?       // Custom display order for employer dashboard (lower = higher priority)

  // Norwegian labor law compliance fields
  eligibleAgeGroups String[] @default([]) // Which age groups can apply: "15-17", "18-20"

  // Community Guardian moderation
  isPaused     Boolean   @default(false) // Soft freeze by guardian
  pausedAt     DateTime?
  pausedReason String?   @db.Text
  pausedById   String?   // Who paused it (guardian or admin)

  // Optional community association (derived from location if not set)
  communityId  String?

  postedById  String
  postedBy    User        @relation(fields: [postedById], references: [id])
  community   Community?  @relation(fields: [communityId], references: [id])

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  applications    Application[]
  reviews         Review[]
  pokes           Poke[]
  earnings        Earning[]
  recommendations Recommendation[]
  conversations   Conversation[]
  jobCompletions  JobCompletion[]

  @@index([postedById])
  @@index([category])
  @@index([status])
  @@index([location])
  @@index([dateTime])
  @@index([applicationDeadline])
  @@index([displayOrder])
  @@index([communityId])
  @@index([isPaused])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([status, category]) // Composite for filtered job listings
  @@index([status, createdAt]) // Composite for sorted job listings
}

model Application {
  id           String            @id @default(cuid())
  jobId        String
  youthId      String
  message      String            @db.Text
  status       ApplicationStatus @default(PENDING)
  displayOrder Int?              // Custom display order for youth's applications view (lower = higher priority)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  job   MicroJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  youth User     @relation(fields: [youthId], references: [id], onDelete: Cascade)

  @@unique([jobId, youthId])
  @@index([jobId])
  @@index([youthId])
  @@index([status])
  @@index([displayOrder])
}

model Review {
  id               String   @id @default(cuid())
  jobId            String
  reviewerId       String
  reviewedId       String
  punctuality      Int      // 1-5
  communication    Int      // 1-5
  reliability      Int      // 1-5
  overall          Int      // 1-5
  positiveTags     String[] // e.g., "polite", "problem solver"
  comment          String?  @db.Text // Written feedback
  createdAt        DateTime @default(now())

  job      MicroJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  reviewer User     @relation("ReviewsGiven", fields: [reviewerId], references: [id])
  reviewed User     @relation("ReviewsReceived", fields: [reviewedId], references: [id])

  @@unique([jobId, reviewerId, reviewedId])
  @@index([jobId])
  @@index([reviewedId])
}

model CareerCard {
  id             String   @id @default(cuid())
  roleName       String   @unique
  summary        String   @db.Text
  traits         String[] // Key traits needed
  dayInLife      String[] // Bullet points
  realityCheck   String   @db.Text // What's hard / who it's not for
  salaryBand     String // e.g., "300k-600k NOK"
  companies      String[] // Example companies
  nextSteps      String[] // Suggested actions/resources
  certifications String[] // Required certifications/qualifications
  tags           String[] // For matching with skills
  order          Int      @default(0)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  swipes Swipe[]

  @@index([active])
  @@index([order])
}

model Swipe {
  id           String         @id @default(cuid())
  youthId      String
  careerCardId String
  direction    SwipeDirection
  saved        Boolean        @default(false)
  createdAt    DateTime       @default(now())

  youth      User       @relation(fields: [youthId], references: [id], onDelete: Cascade)
  careerCard CareerCard @relation(fields: [careerCardId], references: [id], onDelete: Cascade)

  @@unique([youthId, careerCardId])
  @@index([youthId])
  @@index([careerCardId])
  @@index([saved])
}

model ProQuestion {
  id               String         @id @default(cuid())
  youthId          String
  question         String         @db.Text
  category         String? // e.g., "Tech", "Healthcare", "Creative"
  relatedCareerIds String[] // Career card IDs this relates to
  tags             String[] // For search/filtering
  status           QuestionStatus @default(PENDING)
  moderatedBy      String?
  moderatedAt      DateTime?
  rejectionReason  String?        @db.Text
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  youth   User         @relation(fields: [youthId], references: [id], onDelete: Cascade)
  answers ProAnswer[]

  @@index([youthId])
  @@index([status])
  @@index([createdAt])
  @@index([category])
}

model ProAnswer {
  id                 String    @id @default(cuid())
  questionId         String
  answeredBy         String
  answerText         String    @db.Text
  professionalTitle  String? // e.g., "Senior Software Engineer"
  professionalCompany String? // e.g., "Google"
  yearsExperience    Int?
  publishedAt        DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  question ProQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answerer User        @relation(fields: [answeredBy], references: [id])

  @@index([questionId])
  @@index([answeredBy])
  @@index([publishedAt])
}

model Report {
  id         String       @id @default(cuid())
  reporterId String
  targetType String // "user", "job", "question", "answer"
  targetId   String
  reason     String       @db.Text
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  reporter User @relation(fields: [reporterId], references: [id])

  @@index([reporterId])
  @@index([status])
  @@index([targetType, targetId])
}

model AiIntentLog {
  id         String   @id @default(cuid())
  userId     String?
  intentType String // "concierge", "career_explain", "next_steps", "message_draft"
  metadata   Json? // Anonymous structured data
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([intentType])
  @@index([createdAt])
}

model HelpDoc {
  id        String   @id @default(cuid())
  slug      String   @unique
  title     String
  content   String   @db.Text
  tags      String[]
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([active])
}

model Poke {
  id          String     @id @default(cuid())
  employerId  String
  youthId     String
  jobId       String?    // Optional: if poke is for a specific job
  message     String?    @db.Text
  status      PokeStatus @default(PENDING)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  employer User @relation("EmployerPokes", fields: [employerId], references: [id], onDelete: Cascade)
  youth    User @relation("YouthReceivedPokes", fields: [youthId], references: [id], onDelete: Cascade)
  job      MicroJob? @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@unique([employerId, youthId, jobId])
  @@index([employerId])
  @@index([youthId])
  @@index([status])
  @@index([createdAt])
}

enum NotificationType {
  NEW_APPLICATION
  APPLICATION_ACCEPTED
  APPLICATION_REJECTED
  JOB_COMPLETED
  NEW_REVIEW
  NEW_POKE
  NEW_RECOMMENDATION
  NEW_MESSAGE
  SYSTEM
  // Safety & verification
  GUARDIAN_CONSENT_REQUESTED  // Sent to youth when guardian consent email is sent
  GUARDIAN_CONSENT_RECEIVED   // Sent to youth when guardian gives consent
  ACCOUNT_VERIFIED            // Account fully verified and active
  ACCOUNT_SUSPENDED           // Account suspended
  VERIFICATION_REMINDER       // Reminder to complete verification
  // Community Guardian
  COMMUNITY_REPORT_RECEIVED   // Guardian receives new report
  COMMUNITY_ACTION_TAKEN      // User notified of guardian action (post/account paused)
  REPORT_ESCALATED            // Admin notified of escalation
}

enum RecommendationStatus {
  PENDING     // Initial state
  VIEWED      // Employer has seen it
  CONTACTED   // Employer contacted the recommended youth
  HIRED       // Recommended youth got the job
  DISMISSED   // Employer dismissed the recommendation
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?          // Optional link to navigate to
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// Earnings tracking for youth workers
enum EarningStatus {
  PENDING    // Job completed but not yet paid
  CONFIRMED  // Payment confirmed by employer
}

model Earning {
  id        String        @id @default(cuid())
  youthId   String
  jobId     String
  amount    Float
  status    EarningStatus @default(PENDING)
  note      String?       // Optional note about the earning
  earnedAt  DateTime      @default(now()) // When the job was completed
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  youth User     @relation(fields: [youthId], references: [id], onDelete: Cascade)
  job   MicroJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([youthId, jobId]) // One earning per job per youth
  @@index([youthId])
  @@index([jobId])
  @@index([status])
  @@index([earnedAt])
}

// Achievement badges for youth workers
enum BadgeType {
  FIRST_JOB          // Completed first job
  FIVE_JOBS          // Completed 5 jobs
  TEN_JOBS           // Completed 10 jobs
  TWENTY_FIVE_JOBS   // Completed 25 jobs
  FIFTY_JOBS         // Completed 50 jobs
  FIVE_STAR_RATING   // Received a 5-star rating
  RATING_STREAK      // 3 consecutive 5-star ratings
  QUICK_RESPONDER    // Responded to applications quickly
  RELIABLE           // High reliability score (90%+)
  SUPER_RELIABLE     // Perfect reliability score (100%)
  EARLY_BIRD         // Joined in first month
  CATEGORY_MASTER    // Completed 5+ jobs in one category
  MULTI_TALENTED     // Completed jobs in 3+ categories
  FIRST_REVIEW       // Received first review
  HIGHLY_RATED       // Average rating above 4.5
}

model Badge {
  id        String    @id @default(cuid())
  youthId   String
  type      BadgeType
  earnedAt  DateTime  @default(now())
  metadata  Json?     // Additional data (e.g., category for CATEGORY_MASTER)

  youth User @relation(fields: [youthId], references: [id], onDelete: Cascade)

  @@unique([youthId, type]) // Each badge can only be earned once per youth
  @@index([youthId])
  @@index([type])
  @@index([earnedAt])
}

// Recommendations - Youth recommending other youth for jobs
model Recommendation {
  id              String               @id @default(cuid())
  recommenderId   String               // Youth who made the recommendation
  recommendedId   String               // Youth being recommended
  jobId           String               // Job being recommended for
  employerId      String               // Employer who owns the job
  message         String?              @db.Text
  status          RecommendationStatus @default(PENDING)
  createdAt       DateTime             @default(now())

  recommender     User      @relation("RecommendationsMade", fields: [recommenderId], references: [id], onDelete: Cascade)
  recommended     User      @relation("RecommendationsReceived", fields: [recommendedId], references: [id], onDelete: Cascade)
  job             MicroJob  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  employer        User      @relation("RecommendationsForEmployer", fields: [employerId], references: [id], onDelete: Cascade)

  @@unique([recommenderId, recommendedId, jobId]) // Prevent duplicate recommendations
  @@index([recommenderId])
  @@index([recommendedId])
  @@index([jobId])
  @@index([employerId])
}

// Conversation status for safety controls
enum ConversationStatus {
  ACTIVE        // Normal active conversation
  FROZEN        // Frozen due to report - no new messages allowed
  CLOSED        // Conversation ended normally
}

// Conversations for messaging between any users (universal messaging)
// Phase 1 Safety: Conversations must be job-related and use structured messages
model Conversation {
  id             String             @id @default(cuid())
  participant1Id String             // First participant (any user - smaller ID for normalization)
  participant2Id String             // Second participant (any user - larger ID for normalization)
  jobId          String             // REQUIRED: conversation must be tied to a job (Phase 1 Safety)
  status         ConversationStatus @default(ACTIVE) // Safety status
  frozenAt       DateTime?          // When conversation was frozen
  frozenReason   String?            @db.Text // Why it was frozen
  lastMessageAt  DateTime           @default(now())
  createdAt      DateTime           @default(now())

  participant1 User               @relation("ConversationParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2 User               @relation("ConversationParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  job          MicroJob           @relation(fields: [jobId], references: [id], onDelete: Cascade)
  messages     Message[]
  reports      ConversationReport[]
  paymentAgreement PaymentAgreement? // Informational payment agreement

  @@unique([participant1Id, participant2Id, jobId])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([jobId])
  @@index([status])
  @@index([lastMessageAt])
}

// ============================================
// PAYMENT AGREEMENT (INFORMATIONAL ONLY - NO TRANSACTIONS)
// ============================================
// This table records agreed payment terms ONLY.
// NO money moves through the platform.
// Payments happen externally (Vipps, cash, bank transfer).
// This is for transparency and dispute prevention only.

model PaymentAgreement {
  id             String                 @id @default(cuid())
  conversationId String                 @unique // One agreement per conversation
  paymentMethod  PaymentMethod          // VIPPS, CASH, BANK_TRANSFER
  agreedAmount   Float?                 // Optional: agreed amount in NOK
  currency       String                 @default("NOK") // Always NOK for Norway
  status         PaymentAgreementStatus @default(AGREED)

  // Tracking (informational only)
  markedPaidById String?                // User who marked as paid (optional)
  markedPaidAt   DateTime?              // When marked as paid
  notes          String?                @db.VarChar(200) // Short note (max 200 chars)

  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  conversation   Conversation           @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  markedPaidBy   User?                  @relation("PaymentMarkedBy", fields: [markedPaidById], references: [id])

  @@index([conversationId])
  @@index([status])
}

// Message template direction - who can use this template
enum MessageTemplateDirection {
  ANY              // Either party can use
  ADULT_TO_YOUTH   // Only adults/employers can send to youth
  YOUTH_TO_ADULT   // Only youth can send to adults/employers
}

// Message templates for structured messaging (Phase 1 Safety)
// No free-text allowed - messages must use approved templates
model MessageTemplate {
  id            String                   @id @default(cuid())
  key           String                   @unique // e.g., "ASK_AVAILABILITY"
  label         String                   // Shown in UI
  description   String?                  // Help text for users
  allowedFields Json                     // Structured input fields
  direction     MessageTemplateDirection @default(ANY)
  isActive      Boolean                  @default(true)
  category      String?                  // Group templates (e.g., "scheduling", "payment")
  sortOrder     Int                      @default(0)
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt

  messages Message[]

  @@index([key])
  @@index([isActive])
  @@index([direction])
  @@index([category])
}

// Messages - Phase 1 Safety: Only structured messages via templates
// IMPORTANT: Free-text messaging is DISABLED for safety.
// All new messages MUST use templates (enforced at API level).
model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String

  // Structured messaging (REQUIRED for all new messages)
  templateId     String?  // Template used (nullable for legacy messages only)
  payload        Json?    // Validated fields from template
  renderedText   String?  @db.Text // Server-generated safe text

  // Legacy field - DO NOT USE for new messages
  // Kept for backward compatibility with existing data
  content        String?  @db.Text // @deprecated - use templateId + payload instead

  read           Boolean  @default(false)
  createdAt      DateTime @default(now())

  conversation Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User             @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  template     MessageTemplate? @relation(fields: [templateId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@index([templateId])
  @@index([createdAt])
  @@index([read])
  @@index([conversationId, senderId, read]) // Composite for unread count queries
}

// User blocks - prevents messaging and conversation creation
model UserBlock {
  id         String   @id @default(cuid())
  blockerId  String   // User who created the block
  blockedId  String   // User who is blocked
  reason     String?  @db.Text // Optional reason (private)
  createdAt  DateTime @default(now())

  blocker User @relation("BlocksMade", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("BlocksReceived", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

// Conversation report categories (Phase 1 Safety)
enum ConversationReportCategory {
  GROOMING          // Predatory behavior
  SEXUAL_CONTENT    // Inappropriate sexual content
  OFF_PLATFORM      // Attempting to move off platform
  HARASSMENT        // Bullying or harassment
  INAPPROPRIATE_JOB // Job posting is inappropriate for minors
  OTHER             // Other safety concern
}

// Conversation report status
enum ConversationReportStatus {
  OPEN        // New report, not yet reviewed
  IN_REVIEW   // Being reviewed by admin/guardian
  RESOLVED    // Action taken and resolved
  DISMISSED   // Reviewed but no action needed
}

// Conversation reports - safety reporting system
// On insert: auto-freezes the conversation
model ConversationReport {
  id             String                     @id @default(cuid())
  reporterId     String                     // User who made the report
  reportedId     String                     // User being reported
  conversationId String                     // Conversation where issue occurred
  category       ConversationReportCategory
  details        String?                    @db.VarChar(500) // Short details (max 500 chars)
  status         ConversationReportStatus   @default(OPEN)

  // Review tracking
  reviewerId     String?                    // Admin/Guardian who reviewed
  reviewerNote   String?                    @db.Text // Internal note
  reviewedAt     DateTime?
  actionTaken    String?                    // What action was taken

  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt

  reporter     User         @relation("ReportsMade", fields: [reporterId], references: [id], onDelete: Cascade)
  reported     User         @relation("ReportsReceived", fields: [reportedId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([reporterId])
  @@index([reportedId])
  @@index([conversationId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
}

// Favorite workers for employers
model FavoriteWorker {
  id         String   @id @default(cuid())
  employerId String
  youthId    String
  note       String?  @db.Text // Optional note about why they're favorited
  createdAt  DateTime @default(now())

  employer User @relation("EmployerFavorites", fields: [employerId], references: [id], onDelete: Cascade)
  youth    User @relation("FavoritedBy", fields: [youthId], references: [id], onDelete: Cascade)

  @@unique([employerId, youthId])
  @@index([employerId])
  @@index([youthId])
}

// Private notes on workers (for employers)
model WorkerNote {
  id         String   @id @default(cuid())
  employerId String
  youthId    String
  content    String   @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  employer User @relation("EmployerNotes", fields: [employerId], references: [id], onDelete: Cascade)
  youth    User @relation("NotesAbout", fields: [youthId], references: [id], onDelete: Cascade)

  @@unique([employerId, youthId]) // One note per youth per employer
  @@index([employerId])
  @@index([youthId])
}

// Job templates for quick re-posting
model JobTemplate {
  id             String      @id @default(cuid())
  employerId     String
  name           String      // Template name for easy identification
  title          String
  category       JobCategory
  description    String      @db.Text
  payType        PayType
  payAmount      Float
  location       String
  latitude       Float?      // For map view
  longitude      Float?      // For map view
  duration       Int?
  requiredTraits String[]
  usageCount     Int         @default(0) // How many times this template was used
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  employer User @relation(fields: [employerId], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@index([usageCount])
}

// Audit log for safety-critical actions (GDPR compliance)
enum AuditAction {
  // Account lifecycle
  ACCOUNT_CREATED
  ACCOUNT_VERIFIED
  ACCOUNT_SUSPENDED
  ACCOUNT_BANNED
  ACCOUNT_REINSTATED
  ACCOUNT_DELETED
  // Consent
  GUARDIAN_CONSENT_REQUESTED
  GUARDIAN_CONSENT_GRANTED
  GUARDIAN_CONSENT_REVOKED
  TERMS_ACCEPTED
  PRIVACY_CONSENT_GRANTED
  // Verification
  EID_VERIFICATION_STARTED
  EID_VERIFICATION_COMPLETED
  EID_VERIFICATION_FAILED
  AGE_VERIFIED
  EMAIL_VERIFIED
  PHONE_VERIFIED
  // Data access
  DATA_EXPORT_REQUESTED
  DATA_EXPORT_COMPLETED
  DATA_DELETION_REQUESTED
  DATA_DELETION_COMPLETED
  // Safety actions
  USER_REPORTED
  CONTENT_MODERATED
  MESSAGE_FLAGGED
  // Community Guardian actions
  COMMUNITY_REPORT_CREATED
  COMMUNITY_REPORT_CLAIMED
  COMMUNITY_REPORT_ESCALATED
  COMMUNITY_REPORT_RESOLVED
  JOB_PAUSED
  JOB_UNPAUSED
  USER_PAUSED
  USER_UNPAUSED
  GUARDIAN_ASSIGNED
  GUARDIAN_DEACTIVATED
  // Safety messaging actions (Phase 1)
  CONVERSATION_CREATED
  CONVERSATION_FROZEN
  CONVERSATION_UNFROZEN
  CONVERSATION_CLOSED
  STRUCTURED_MESSAGE_SENT
  USER_BLOCKED
  USER_UNBLOCKED
  CONVERSATION_REPORTED
  REPORT_REVIEWED
  REPORT_RESOLVED
  REPORT_DISMISSED
}

model AuditLog {
  id          String      @id @default(cuid())
  userId      String?     // User who performed or is subject of action
  actorId     String?     // Admin/system who performed action (if different)
  action      AuditAction
  targetType  String?     // e.g., "user", "job", "message"
  targetId    String?     // ID of affected resource
  metadata    Json?       // Additional context (IP, reason, etc.)
  ipAddress   String?     // For security auditing
  userAgent   String?     // For security auditing
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([actorId])
  @@index([action])
  @@index([createdAt])
  @@index([targetType, targetId])
}

// Consent records (GDPR Article 7)
model ConsentRecord {
  id          String   @id @default(cuid())
  userId      String
  consentType String   // e.g., "terms", "privacy", "marketing", "guardian"
  version     String   // Version of terms/policy consented to
  granted     Boolean  @default(true)
  grantedAt   DateTime @default(now())
  revokedAt   DateTime?
  ipAddress   String?
  userAgent   String?

  @@index([userId])
  @@index([consentType])
  @@index([grantedAt])
}

// Legal acceptance records for Terms of Service and Privacy Policy
// Required at sign-up and tracked for compliance
model LegalAcceptance {
  id                 String   @id @default(uuid())
  userId             String   @unique
  acceptedTermsAt    DateTime
  acceptedPrivacyAt  DateTime
  termsVersion       String   @default("v1")
  privacyVersion     String   @default("v1")
  ipAddress          String?
  userAgent          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

// ============================================
// COMMUNITY GUARDIAN SYSTEM (Optional Safety Layer)
// ============================================

// Community - represents a local area/group
model Community {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Oslo Central", "Bergen North"
  description String?  @db.Text
  location    String?  // General location/area
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  guardians   CommunityGuardian[]
  reports     CommunityReport[]
  jobs        MicroJob[]

  @@index([name])
  @@index([isActive])
}

// CommunityGuardian - assigns a user as guardian for a community
// A community may have 0 or 1 active guardian (for MVP)
model CommunityGuardian {
  id              String   @id @default(cuid())
  communityId     String
  guardianUserId  String
  isActive        Boolean  @default(true)
  assignedAt      DateTime @default(now())
  deactivatedAt   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  community       Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  guardian        User      @relation("GuardianUser", fields: [guardianUserId], references: [id], onDelete: Cascade)

  @@unique([communityId, guardianUserId])
  @@index([guardianUserId])
  @@index([communityId])
  @@index([isActive])
}

// CommunityReport - reports submitted for community guardian review
// Reports work even if no guardian exists (visible to admins)
model CommunityReport {
  id                      String                   @id @default(cuid())
  communityId             String
  reporterUserId          String
  targetType              CommunityReportTargetType
  targetId                String                   // Job ID or User ID
  reason                  String                   // Short reason code
  details                 String?                  @db.Text // Optional additional details
  status                  CommunityReportStatus    @default(OPEN)

  // Guardian handling
  assignedGuardianUserId  String?                  // Guardian who claimed this report
  guardianNote            String?                  @db.Text
  escalatedToAdmin        Boolean                  @default(false)

  // Action tracking
  actionTaken             String?                  // What action was taken (e.g., "paused_post")
  actionTakenAt           DateTime?

  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt

  // Relations
  community               Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  reporter                User      @relation("CommunityReporter", fields: [reporterUserId], references: [id], onDelete: Cascade)
  assignedGuardian        User?     @relation("AssignedGuardian", fields: [assignedGuardianUserId], references: [id])

  @@index([communityId, status])
  @@index([reporterUserId])
  @@index([targetType, targetId])
  @@index([assignedGuardianUserId])
  @@index([status])
}

// ============================================
// LIFE SKILLS TRACK (Contextual Micro-Guidance)
// ============================================

// Audience for life skill cards
enum LifeSkillAudience {
  YOUTH
}

// Source of recommendation (rules-based or AI)
enum LifeSkillRecommendationSource {
  RULES
  AI
}

// View status for life skill cards
enum LifeSkillViewStatus {
  SHOWN
  DISMISSED
  SAVED
}

// Life Skill Cards - approved micro-guidance content
// Only 10 cards in v1, strictly controlled content
model LifeSkillCard {
  id        String            @id @default(cuid())
  key       String            @unique // e.g., "FIRST_JOB_ACCEPTED"
  title     String            // Short title
  body      String            @db.Text // 2-5 sentences of guidance
  tags      String[]          // e.g., ['communication', 'boundaries']
  audience  LifeSkillAudience @default(YOUTH)
  isActive  Boolean           @default(true)
  version   String            @default("v1")
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  // Relations
  recommendations LifeSkillRecommendation[]
  views           LifeSkillView[]

  @@index([key])
  @@index([isActive])
  @@index([audience])
}

// Life Skill Events - tracks when trigger events occur
// Used for analytics, idempotency, and linking recommendations
model LifeSkillEvent {
  id        String   @id @default(cuid())
  userId    String
  eventType String   // e.g., "JOB_ACCEPTED", "MESSAGE_SENT_FIRST"
  entityId  String?  // Optional: jobId, conversationId, etc.
  metadata  Json?    // Minimal metadata (no sensitive content)
  createdAt DateTime @default(now())

  // Relations
  user            User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  recommendation  LifeSkillRecommendation?

  @@unique([userId, eventType, entityId]) // Prevent duplicate events
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
}

// Life Skill Recommendations - links events to card recommendations
// One recommendation per event
model LifeSkillRecommendation {
  id       String                         @id @default(cuid())
  userId   String
  eventId  String                         @unique // One recommendation per event
  cardId   String
  source   LifeSkillRecommendationSource  @default(RULES)
  reason   String?                        @db.VarChar(140) // Short reason (<= 140 chars)
  createdAt DateTime                      @default(now())

  // Relations
  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  event LifeSkillEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  card  LifeSkillCard  @relation(fields: [cardId], references: [id], onDelete: Cascade)
  views LifeSkillView[]

  @@index([userId])
  @@index([cardId])
  @@index([source])
  @@index([createdAt])
}

// Life Skill Views - tracks user interactions with cards
model LifeSkillView {
  id               String              @id @default(cuid())
  userId           String
  cardId           String
  recommendationId String?             // Optional: linked recommendation
  status           LifeSkillViewStatus @default(SHOWN)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  // Relations
  user           User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  card           LifeSkillCard            @relation(fields: [cardId], references: [id], onDelete: Cascade)
  recommendation LifeSkillRecommendation? @relation(fields: [recommendationId], references: [id], onDelete: SetNull)

  @@unique([userId, cardId, recommendationId]) // One view per card per recommendation
  @@index([userId])
  @@index([cardId])
  @@index([status])
  @@index([createdAt])
}

// User Preferences - stores user settings
model UserPreferences {
  id              String   @id @default(cuid())
  userId          String   @unique
  showLifeSkills  Boolean  @default(true) // Toggle for life skills tips
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// GROWTH & SKILLS TRACKING (Features 4 & 5)
// ============================================

// Skill categories for taxonomy
enum SkillCategory {
  SERVICE    // Customer-facing, hospitality
  TECH       // Technology, digital
  CARE       // Childcare, elderly care, pet care
  HOME       // Cleaning, organizing, home maintenance
  OUTDOOR    // Lawn, garden, snow clearing
  CREATIVE   // Art, crafts, content creation
  OTHER
}

// Skill - taxonomy of demonstrable skills
model Skill {
  id        String        @id @default(cuid())
  slug      String        @unique
  name      String
  category  SkillCategory
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([category])
  @@index([slug])
}

// Job completion outcomes
enum JobCompletionOutcome {
  COMPLETED        // Job done successfully
  NO_SHOW          // Worker didn't show up
  CANCELLED        // Cancelled before start
  ISSUE_REPORTED   // Completed but with issues
}

// Supervision level during job
enum SupervisionLevel {
  SUPERVISED       // Adult present during work
  UNSUPERVISED     // Youth worked alone
  UNKNOWN          // Not tracked
}

// JobCompletion - explicit tracking of completed jobs
model JobCompletion {
  id           String               @id @default(cuid())
  jobId        String
  youthId      String               // Teen who completed the job
  employerId   String               // Adult who hired
  outcome      JobCompletionOutcome @default(COMPLETED)
  supervision  SupervisionLevel     @default(UNKNOWN)
  hoursWorked  Decimal?             @db.Decimal(5, 2) // e.g., 2.50 hours
  completedAt  DateTime             @default(now())
  notes        String?              @db.Text // Private employer notes
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  // Relations
  job      MicroJob            @relation(fields: [jobId], references: [id], onDelete: Cascade)
  youth    User                @relation("YouthJobCompletions", fields: [youthId], references: [id], onDelete: Cascade)
  employer User                @relation("EmployerJobCompletions", fields: [employerId], references: [id], onDelete: Cascade)
  feedback StructuredFeedback?

  @@unique([jobId, youthId]) // One completion per job per youth
  @@index([jobId])
  @@index([youthId])
  @@index([employerId])
  @@index([outcome])
  @@index([completedAt])
}

// Responsibility level demonstrated
enum ResponsibilityLevel {
  BASIC        // Followed basic instructions
  INTERMEDIATE // Showed initiative, solved problems
  ADVANCED     // Led tasks, mentored others, high autonomy
}

// StructuredFeedback - NO free text ratings (safety requirement)
model StructuredFeedback {
  id                  String             @id @default(cuid())
  jobCompletionId     String             @unique

  // Structured ratings (1-5 scale)
  punctuality         Int                // 1-5: Was on time
  communication       Int                // 1-5: Communicated clearly
  quality             Int                // 1-5: Quality of work
  respectfulness      Int                // 1-5: Respectful behavior
  followedInstructions Int               // 1-5: Followed instructions

  // Binary/enum fields
  wouldRehire         Boolean            // Would hire again
  responsibilityLevel ResponsibilityLevel @default(BASIC)

  // Skills demonstrated (stored as slug array)
  skillsDemonstrated  String[]           // Array of skill slugs

  createdAt           DateTime           @default(now())

  // Relations
  jobCompletion JobCompletion @relation(fields: [jobCompletionId], references: [id], onDelete: Cascade)

  @@index([jobCompletionId])
  @@index([createdAt])
}

// Trust signal types (internal, non-public)
enum TrustSignalType {
  ON_TIME               // Consistently on time
  GOOD_COMMS            // Good communication
  REPEAT_HIRE           // Re-hired by same employer
  HELPED_OTHER          // Helped another youth
  COMMUNITY_REPORT_RESOLVED // Resolved a community issue positively
  POSITIVE_TREND        // Improving scores over time
  CONSISTENCY_STREAK    // Consistent performance
}

// Trust signal sources
enum TrustSignalSource {
  JOB_COMPLETION  // From completing a job
  FEEDBACK        // From receiving feedback
  SYSTEM          // System-generated
  COMMUNITY       // Community guardian action
}

// TrustSignal - private indicators (NEVER public)
model TrustSignal {
  id         String            @id @default(cuid())
  userId     String            // Teen who earned the signal
  type       TrustSignalType
  sourceType TrustSignalSource
  sourceId   String?           // Reference to source (jobId, feedbackId, etc.)
  weight     Int               @default(1) // Signal strength
  expiresAt  DateTime?         // Optional expiry for temporary signals
  createdAt  DateTime          @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([sourceType])
  @@index([createdAt])
}

// ============================================
// CAREER REALITY CHECKS (Feature 6)
// ============================================

// CareerRealityCheck - honest career information
model CareerRealityCheck {
  id              String   @id @default(cuid())
  roleSlug        String   @unique // Matches CareerCard roleName or standalone
  title           String
  overview        String   @db.Text

  // Structured content (stored as JSON arrays)
  dayToDay        Json     // String[] - typical daily activities
  misconceptions  Json     // String[] - common wrong assumptions
  hardParts       Json     // String[] - challenges to expect
  starterSteps    Json     // String[] - how to get started
  typicalPath     Json     // String[] - career progression
  skillGaps       Json     // String[] - skills youth typically lack

  // Market context (neutral, factual)
  saturationNote  String   @db.VarChar(300) // Short market note

  // Metadata
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([roleSlug])
  @@index([isActive])
}
